<!DOCTYPE html>
<html
  itemscope
  itemtype="http://schema.org/WebPage"
  lang="en"
  class="color-toggle-hidden"
>
  <head>
    <meta charset="UTF-8" />
<meta name="referrer" content="no-referrer" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="generator" content="Hugo 0.93.3" />
  <meta name="description" content="This blog post details the solution of the challenge 8 of the Flare-On 9.
   Challenge 8 - backdoor  Description First look Understanding the first layer of obfuscation Recovering the first layer methods Understanding the second layer of obfuscation Recovering the second layer methods Analyzing the backdoor  Initialization Communication protocol Command execution   Decrypting the final stage        Here are the links to the other solutions:" />
    <meta name="author" content="icecr4ck" />

    <title>Flare-On 9 solutions (part 3) | RE-Dojo</title>

    <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg" />
<link
  rel="icon"
  type="image/png"
  sizes="48x48"
  href="/favicon/favicon-32x32.png"
/>
<link
  rel="icon"
  type="image/png"
  sizes="32x32"
  href="/favicon/favicon-32x32.png"
/>
<link
  rel="icon"
  type="image/png"
  sizes="16x16"
  href="/favicon/favicon-16x16.png"
/>

    

    
  <meta
    property="og:title"
    content="Flare-On 9 solutions (part 3)"
  />
  <meta property="og:site_name" content="RE-Dojo" />
  <meta property="og:description" content="This blog post details the solution of the challenge 8 of the Flare-On 9.
   Challenge 8 - backdoor  Description First look Understanding the first layer of obfuscation Recovering the first layer methods Understanding the second layer of obfuscation Recovering the second layer methods Analyzing the backdoor  Initialization Communication protocol Command execution   Decrypting the final stage        Here are the links to the other solutions:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://re-dojo.github.io/post/2022-11-13-FlareOn-9-part-3/" />

<meta property="article:section" content="Post" />
    <meta
      property="article:published_time"
      content="2022-11-13T00:00:00+00:00"
    />
    <meta
      property="article:modified_time"
      content="2022-11-13T00:00:00+00:00"
    />


  <meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Flare-On 9 solutions (part 3)" />
  <meta name="twitter:description" content="This blog post details the solution of the challenge 8 of the Flare-On 9.
   Challenge 8 - backdoor  Description First look Understanding the first layer of obfuscation Recovering the first layer methods Understanding the second layer of obfuscation Recovering the second layer methods Analyzing the backdoor  Initialization Communication protocol Command execution   Decrypting the final stage        Here are the links to the other solutions:" />

<script type="application/ld+json">
  {
      "@context": "http://schema.org",
      "@type": "BlogPosting",
      "articleSection": "Post",
      "name": "Flare-On 9 solutions (part 3)",
      "url" : "https://re-dojo.github.io/post/2022-11-13-FlareOn-9-part-3/",
      "headline": "Flare-On 9 solutions (part 3)",
      "description": "This blog post details the solution of the challenge 8 of the Flare-On 9.\n   Challenge 8 - backdoor  Description First look Understanding the first layer of obfuscation Recovering the first layer methods Understanding the second layer of obfuscation Recovering the second layer methods Analyzing the backdoor  Initialization Communication protocol Command execution   Decrypting the final stage        Here are the links to the other solutions:",
      "wordCount" : "1677",
      "license": "CC BY-SA 4.0",
      "inLanguage": "en",
      "isFamilyFriendly": "true",
      "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": "https://re-dojo.github.io/post/2022-11-13-FlareOn-9-part-3/"
      },
      "keywords" : [ "Challenge" , "Reverse" ],
      "author" : [
          {
              "@type": "Person",
              "name": "icecr4ck"
          }
      ],
      "copyrightHolder" : "RE-Dojo",
      "copyrightYear" : "2022",
      "dateCreated": "2022-11-13T00:00:00.00Z",
      "datePublished": "2022-11-13T00:00:00.00Z",
      "dateModified": "2022-11-13T00:00:00.00Z",
      "publisher":{
          "@type":"Organization",
          "name": "RE-Dojo",
          "url": "https://re-dojo.github.io/",
          "logo": {
              "@type": "ImageObject",
              "url": "https://re-dojo.github.io/images/brand/logo.svg",
              "width":"32",
              "height":"32"
          }
      }
  }
  </script>


    <script src="/js/main-8d4fb56f.bundle.min.js"></script>

<link
  rel="preload"
  as="font"
  href="/fonts/Metropolis.woff2"
  type="font/woff2"
  crossorigin="anonymous"
/>
<link
  rel="preload"
  as="font"
  href="/fonts/LiberationSans.woff2"
  type="font/woff2"
  crossorigin="anonymous"
/>
<link
  rel="preload"
  as="font"
  href="/fonts/GeekblogIcons.woff2"
  type="font/woff2"
  crossorigin="anonymous"
/>

<link
  rel="preload"
  href="/main-67545b00.min.css"
  as="style"
/>
<link
  rel="stylesheet"
  href="/main-67545b00.min.css"
  media="all"
/>

<link
  rel="preload"
  href="/mobile-3888ed2b.min.css"
  as="style"
/>
<link
  rel="stylesheet"
  href="/mobile-3888ed2b.min.css"
  media="screen and (max-width: 45rem)"
/>

<link
  rel="preload"
  href="/print-8a905a2e.min.css"
  as="style"
/>
<link
  rel="stylesheet"
  href="/print-8a905a2e.min.css"
  media="print"
/>

<link
  rel="preload"
  href="/custom.css"
  as="style"
/>
<link
  rel="stylesheet"
  href="/custom.css"
  media="all"
/>
  <link href="https://re-dojo.github.io/post/2022-11-13-FlareOn-9-part-3/" rel="canonical" type="text/html" />
    <link href="https://re-dojo.github.io/index.xml" rel="alternate" type="application/rss+xml" title="RE-Dojo RSS Feed" />

<!-- Made with Geekblog theme https://github.com/thegeeklab/hugo-geekblog -->

    

  </head>

  <body>
    
  <!-- geekblog include: sprites/geekblog.svg -->
  <svg class="svg-sprite" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><svg viewBox="-7.27 -7.27 46.55 46.55" id="gblog_arrow_back" xmlns="http://www.w3.org/2000/svg"><path d="M31.999 14.035v3.93H7.673l11.134 11.228L16 32 .001 16.001 16 .002l2.807 2.807L7.673 14.037h24.326z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gblog_arrow_left" xmlns="http://www.w3.org/2000/svg"><path d="M7.954 17.965v5.988L.001 16l7.953-7.953v5.988H32v3.93H7.954z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gblog_arrow_right" xmlns="http://www.w3.org/2000/svg"><path d="M24.046 14.035V8.047L31.999 16l-7.953 7.953v-5.988H0v-3.93h24.046z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gblog_bitbucket" xmlns="http://www.w3.org/2000/svg"><path d="M15.905 13.355c.189 1.444-1.564 2.578-2.784 1.839-1.375-.602-1.375-2.784-.034-3.403 1.151-.705 2.818.223 2.818 1.564zm1.907-.361c-.309-2.44-3.076-4.056-5.328-3.042-1.426.636-2.389 2.148-2.32 3.747.086 2.097 2.08 3.815 4.176 3.626s3.729-2.234 3.472-4.331zm4.108-9.315c-.756-.997-2.045-1.169-3.179-1.358-3.214-.516-6.513-.533-9.727.034-1.066.172-2.269.361-2.939 1.323 1.1 1.031 2.664 1.186 4.073 1.358 2.544.327 5.156.344 7.699.017 1.426-.172 3.008-.309 4.073-1.375zm.979 17.788c-.481 1.684-.206 3.953-1.994 4.932-3.076 1.701-6.806 1.89-10.191 1.289-1.787-.327-3.884-.894-4.864-2.578-.43-1.65-.705-3.334-.98-5.018l.103-.275.309-.155c5.121 3.386 12.288 3.386 17.427 0 .808.241.206 1.22.189 1.805zM26.01 4.951c-.584 3.764-1.255 7.51-1.908 11.257-.189 1.1-1.255 1.719-2.148 2.183-3.214 1.615-6.96 1.89-10.483 1.512-2.389-.258-4.829-.894-6.771-2.389-.911-.705-.911-1.908-1.083-2.922-.602-3.523-1.289-7.046-1.719-10.604.206-1.547 1.942-2.217 3.231-2.698C6.848.654 8.686.362 10.508.19c3.884-.378 7.854-.241 11.618.859 1.341.395 2.784.945 3.695 2.097.412.533.275 1.203.189 1.805z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gblog_bookmark" xmlns="http://www.w3.org/2000/svg"><path d="M20.357 5.856q1.157 0 2.043.851t.885 2.008v23.284l-10.212-4.357-10.144 4.357V8.715q0-1.157.885-2.008t2.042-.851h14.502zm5.787 18.859V5.856q0-1.157-.851-2.042t-2.008-.885H8.715q0-1.157.885-2.042t2.043-.885h14.502q1.157 0 2.043.885t.885 2.042v23.216z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gblog_brightness_auto" xmlns="http://www.w3.org/2000/svg"><path d="M16.846 18.938h2.382L15.22 7.785h-2.44L8.772 18.938h2.382l.871-2.44h3.95zm7.087-9.062L27.999 14l-4.066 4.124v5.809h-5.809L14 27.999l-4.124-4.066H4.067v-5.809L.001 14l4.066-4.124V4.067h5.809L14 .001l4.124 4.066h5.809v5.809zm-11.385 4.937L14 10.282l1.452 4.531h-2.904z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gblog_brightness_dark" xmlns="http://www.w3.org/2000/svg"><path d="M14 21.435q3.079 0 5.257-2.178T21.435 14t-2.178-5.257T14 6.565q-1.51 0-3.079.697 1.917.871 3.108 2.701T15.22 14t-1.191 4.037-3.108 2.701q1.568.697 3.079.697zm9.933-11.559L27.999 14l-4.066 4.124v5.809h-5.809L14 27.999l-4.124-4.066H4.067v-5.809L.001 14l4.066-4.124V4.067h5.809L14 .001l4.124 4.066h5.809v5.809z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gblog_brightness_light" xmlns="http://www.w3.org/2000/svg"><path d="M14 21.435q3.079 0 5.257-2.178T21.435 14t-2.178-5.257T14 6.565 8.743 8.743 6.565 14t2.178 5.257T14 21.435zm9.933-3.311v5.809h-5.809L14 27.999l-4.124-4.066H4.067v-5.809L.001 14l4.066-4.124V4.067h5.809L14 .001l4.124 4.066h5.809v5.809L27.999 14z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gblog_check" xmlns="http://www.w3.org/2000/svg"><path d="M8.885 20.197L25.759 3.323l2.24 2.24L8.885 24.677 0 15.792l2.24-2.24z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gblog_clear" xmlns="http://www.w3.org/2000/svg"><path d="M32 3.222L19.222 16 32 28.778l-3.221 3.221-12.778-12.778L3.223 31.999.002 28.778 12.78 16 .002 3.222 3.223.001l12.778 12.778L28.779.001z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gblog_cloud_off" xmlns="http://www.w3.org/2000/svg"><path d="M9.023 10.5H7q-1.914 0-3.281 1.395t-1.367 3.309 1.367 3.281T7 19.852h11.375zM3.5 4.976l1.477-1.477L24.5 23.022l-1.477 1.477-2.352-2.297H6.999q-2.898 0-4.949-2.051t-2.051-4.949q0-2.844 1.969-4.867t4.758-2.133zm19.086 5.578q2.242.164 3.828 1.832T28 16.351q0 3.008-2.461 4.758l-1.695-1.695q1.805-.984 1.805-3.063 0-1.422-1.039-2.461t-2.461-1.039h-1.75v-.602q0-2.68-1.859-4.539t-4.539-1.859q-1.531 0-2.953.711l-1.75-1.695Q11.431 3.5 14.001 3.5q2.953 0 5.496 2.078t3.09 4.977z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gblog_code" xmlns="http://www.w3.org/2000/svg"><path d="M9.917 24.5a1.75 1.75 0 10-3.501.001 1.75 1.75 0 003.501-.001zm0-21a1.75 1.75 0 10-3.501.001A1.75 1.75 0 009.917 3.5zm11.666 2.333a1.75 1.75 0 10-3.501.001 1.75 1.75 0 003.501-.001zm1.75 0a3.502 3.502 0 01-1.75 3.026c-.055 6.581-4.721 8.039-7.82 9.023-2.898.911-3.846 1.349-3.846 3.117v.474a3.502 3.502 0 011.75 3.026c0 1.932-1.568 3.5-3.5 3.5s-3.5-1.568-3.5-3.5c0-1.294.711-2.424 1.75-3.026V6.526A3.502 3.502 0 014.667 3.5c0-1.932 1.568-3.5 3.5-3.5s3.5 1.568 3.5 3.5a3.502 3.502 0 01-1.75 3.026v9.06c.93-.456 1.914-.766 2.807-1.039 3.391-1.075 5.323-1.878 5.359-5.687a3.502 3.502 0 01-1.75-3.026c0-1.932 1.568-3.5 3.5-3.5s3.5 1.568 3.5 3.5z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gblog_contacts" xmlns="http://www.w3.org/2000/svg"><path d="M22.688 22.688v-2q0-1.5-2.281-2.438t-4.406-.938-4.406.938-2.281 2.438v2h13.375zM16 9q-1.25 0-2.125.875T13 12t.875 2.125T16 15t2.125-.875T19 12t-.875-2.125T16 9zm10.688-3.687q1.063 0 1.844.813t.781 1.875v16q0 1.063-.781 1.875t-1.844.813H5.313q-1.063 0-1.844-.813t-.781-1.875v-16q0-1.063.781-1.875t1.844-.813h21.375zM5.313 32v-2.688h21.375V32H5.313zM26.688 0v2.688H5.313V0h21.375z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gblog_copy" xmlns="http://www.w3.org/2000/svg"><path d="M23.502 25.438V7.626H9.562v17.812h13.94zm0-20.315q1.013 0 1.787.745t.774 1.757v17.812q0 1.013-.774 1.787t-1.787.774H9.562q-1.013 0-1.787-.774t-.774-1.787V7.625q0-1.013.774-1.757t1.787-.745h13.94zM19.689 0v2.562H4.438v17.812H1.936V2.562q0-1.013.745-1.787T4.438.001h15.251z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gblog_create" xmlns="http://www.w3.org/2000/svg"><path d="M31.499 7.167l-3.25 3.25-6.666-6.666 3.25-3.25q.5-.5 1.25-.5t1.25.5l4.166 4.166q.5.5.5 1.25t-.5 1.25zM.001 25.333L19.667 5.667l6.666 6.666L6.667 31.999H.001v-6.666z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gblog_date" xmlns="http://www.w3.org/2000/svg"><path d="M27.192 28.844V11.192H4.808v17.652h22.384zm0-25.689q1.277 0 2.253.976t.976 2.253v22.459q0 1.277-.976 2.216t-2.253.939H4.808q-1.352 0-2.291-.901t-.939-2.253V6.385q0-1.277.939-2.253t2.291-.976h1.577V.001h3.23v3.155h12.769V.001h3.23v3.155h1.577zm-3.155 11.267v3.155h-3.23v-3.155h3.23zm-6.46 0v3.155h-3.155v-3.155h3.155zm-6.384 0v3.155h-3.23v-3.155h3.23z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gblog_download" xmlns="http://www.w3.org/2000/svg"><path d="M2.866 28.209h26.269v3.79H2.866v-3.79zm26.268-16.925L16 24.418 2.866 11.284h7.493V.001h11.283v11.283h7.493z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gblog_email" xmlns="http://www.w3.org/2000/svg"><path d="M28.845 9.615v-3.23L16 14.422 3.155 6.385v3.23L16 17.577zm0-6.46q1.277 0 2.216.977T32 6.385v19.23q0 1.277-.939 2.253t-2.216.977H3.155q-1.277 0-2.216-.977T0 25.615V6.385q0-1.277.939-2.253t2.216-.977h25.69z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gblog_git" xmlns="http://www.w3.org/2000/svg"><path d="M27.472 12.753L15.247.529a1.803 1.803 0 00-2.55 0l-2.84 2.84 2.137 2.137a2.625 2.625 0 013.501 3.501l3.499 3.499a2.625 2.625 0 11-1.237 1.237l-3.499-3.499c-.083.04-.169.075-.257.106v7.3a2.626 2.626 0 11-1.75 0v-7.3a2.626 2.626 0 01-1.494-3.607L8.62 4.606l-8.09 8.09a1.805 1.805 0 000 2.551l12.225 12.224a1.803 1.803 0 002.55 0l12.168-12.168a1.805 1.805 0 000-2.551z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gblog_github" xmlns="http://www.w3.org/2000/svg"><path d="M16 .394c8.833 0 15.999 7.166 15.999 15.999 0 7.062-4.583 13.062-10.937 15.187-.813.146-1.104-.354-1.104-.771 0-.521.021-2.25.021-4.396 0-1.5-.5-2.458-1.083-2.958 3.562-.396 7.312-1.75 7.312-7.896 0-1.75-.625-3.167-1.646-4.291.167-.417.708-2.042-.167-4.25-1.333-.417-4.396 1.646-4.396 1.646a15.032 15.032 0 00-8 0S8.937 6.602 7.603 7.018c-.875 2.208-.333 3.833-.167 4.25-1.021 1.125-1.646 2.542-1.646 4.291 0 6.125 3.729 7.5 7.291 7.896-.458.417-.875 1.125-1.021 2.146-.917.417-3.25 1.125-4.646-1.333-.875-1.521-2.458-1.646-2.458-1.646-1.562-.021-.104.979-.104.979 1.042.479 1.771 2.333 1.771 2.333.938 2.854 5.396 1.896 5.396 1.896 0 1.333.021 2.583.021 2.979 0 .417-.292.917-1.104.771C4.582 29.455-.001 23.455-.001 16.393-.001 7.56 7.165.394 15.998.394zM6.063 23.372c.042-.083-.021-.187-.146-.25-.125-.042-.229-.021-.271.042-.042.083.021.187.146.25.104.062.229.042.271-.042zm.646.709c.083-.062.062-.208-.042-.333-.104-.104-.25-.146-.333-.062-.083.062-.062.208.042.333.104.104.25.146.333.062zm.625.937c.104-.083.104-.25 0-.396-.083-.146-.25-.208-.354-.125-.104.062-.104.229 0 .375s.271.208.354.146zm.875.875c.083-.083.042-.271-.083-.396-.146-.146-.333-.167-.417-.062-.104.083-.062.271.083.396.146.146.333.167.417.062zm1.187.521c.042-.125-.083-.271-.271-.333-.167-.042-.354.021-.396.146s.083.271.271.312c.167.062.354 0 .396-.125zm1.313.104c0-.146-.167-.25-.354-.229-.187 0-.333.104-.333.229 0 .146.146.25.354.229.187 0 .333-.104.333-.229zm1.208-.208c-.021-.125-.187-.208-.375-.187-.187.042-.312.167-.292.312.021.125.187.208.375.167s.312-.167.292-.292z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gblog_gitlab" xmlns="http://www.w3.org/2000/svg"><path d="M1.629 11.034L14 26.888.442 17.048a1.09 1.09 0 01-.39-1.203l1.578-4.811zm7.217 0h10.309l-5.154 15.854zM5.753 1.475l3.093 9.559H1.63l3.093-9.559a.548.548 0 011.031 0zm20.618 9.559l1.578 4.811c.141.437-.016.922-.39 1.203l-13.558 9.84 12.371-15.854zm0 0h-7.216l3.093-9.559a.548.548 0 011.031 0z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gblog_heart" xmlns="http://www.w3.org/2000/svg"><path d="M16 29.714a1.11 1.11 0 01-.786-.321L4.072 18.643c-.143-.125-4.071-3.714-4.071-8 0-5.232 3.196-8.357 8.535-8.357 3.125 0 6.053 2.464 7.464 3.857 1.411-1.393 4.339-3.857 7.464-3.857 5.339 0 8.535 3.125 8.535 8.357 0 4.286-3.928 7.875-4.089 8.035L16.785 29.392c-.214.214-.5.321-.786.321z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gblog_keyboard_arrow_down" xmlns="http://www.w3.org/2000/svg"><path d="M3.281 5.36L14 16.079 24.719 5.36 28 8.641l-14 14-14-14z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gblog_keyboard_arrow_left" xmlns="http://www.w3.org/2000/svg"><path d="M25.875 28.25L22.125 32 6.126 16.001 22.125.002l3.75 3.75-12.25 12.25z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gblog_keyboard_arrow_right" xmlns="http://www.w3.org/2000/svg"><path d="M6.125 28.25L18.375 16 6.125 3.75 9.875 0l15.999 15.999L9.875 31.998z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gblog_keyboard_arrow_up" xmlns="http://www.w3.org/2000/svg"><path d="M24.719 22.64L14 11.921 3.281 22.64 0 19.359l14-14 14 14z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gblog_link" xmlns="http://www.w3.org/2000/svg"><path d="M24.037 7.963q3.305 0 5.634 2.366T32 16t-2.329 5.671-5.634 2.366h-6.46v-3.08h6.46q2.028 0 3.493-1.465t1.465-3.493-1.465-3.493-3.493-1.465h-6.46v-3.08h6.46zM9.615 17.578v-3.155h12.77v3.155H9.615zM3.005 16q0 2.028 1.465 3.493t3.493 1.465h6.46v3.08h-6.46q-3.305 0-5.634-2.366T0 16.001t2.329-5.671 5.634-2.366h6.46v3.08h-6.46q-2.028 0-3.493 1.465t-1.465 3.493z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gblog_menu" xmlns="http://www.w3.org/2000/svg"><path d="M.001 5.334h31.998v3.583H.001V5.334zm0 12.416v-3.5h31.998v3.5H.001zm0 8.916v-3.583h31.998v3.583H.001z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gblog_notifications" xmlns="http://www.w3.org/2000/svg"><path d="M25.846 22.154l3.308 3.308v1.615H2.847v-1.615l3.308-3.308V14q0-3.846 1.961-6.692t5.423-3.692V2.462q0-1 .692-1.731T16 0t1.769.731.692 1.731v1.154q3.461.846 5.423 3.692T25.846 14v8.154zM16 32q-1.385 0-2.346-.923t-.962-2.308h6.615q0 1.308-1 2.269T15.999 32z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gblog_person" xmlns="http://www.w3.org/2000/svg"><path d="M16 20.023q5.052 0 10.526 2.199t5.473 5.754v4.023H0v-4.023q0-3.555 5.473-5.754t10.526-2.199zM16 16q-3.275 0-5.614-2.339T8.047 8.047t2.339-5.661T16 0t5.614 2.386 2.339 5.661-2.339 5.614T16 16z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gblog_pin" xmlns="http://www.w3.org/2000/svg"><path d="M17.6 19.2h9.6v-1.6L22.4 16V3.2l4.8-1.6V0H4.8v1.6l4.8 1.6V16l-4.8 1.6v1.6h9.6v11.2L16 32l1.6-1.6V19.2z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gblog_rss_feed" xmlns="http://www.w3.org/2000/svg"><path d="M-.481 12.048q8.482 0 14.457 5.976t5.976 14.457h-5.879q0-5.976-4.289-10.264T-.48 17.928v-5.879zm0-11.565q13.204 0 22.601 9.397t9.397 22.601h-5.783q0-10.891-7.662-18.553T-.481 6.266V.483zm0 27.468q0-1.831 1.301-3.132t3.229-1.301 3.181 1.253 1.253 3.181-1.301 3.229-3.132 1.301q-1.928 0-3.229-1.301T-.48 27.952z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gblog_search" xmlns="http://www.w3.org/2000/svg"><path d="M11.925 20.161q3.432 0 5.834-2.402t2.402-5.834-2.402-5.834-5.834-2.402-5.834 2.402-2.402 5.834 2.402 5.834 5.834 2.402zm10.981 0L32 29.255 29.255 32l-9.094-9.094v-1.458l-.515-.515q-3.26 2.831-7.721 2.831-4.976 0-8.45-3.432T.001 11.925t3.474-8.45 8.45-3.474 8.407 3.474 3.432 8.45q0 1.802-.858 4.075t-1.973 3.646l.515.515h1.458z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gblog_security" xmlns="http://www.w3.org/2000/svg"><path d="M16 0l13.072 5.855v8.715q0 6.059-3.745 11.063T16 31.999q-5.583-1.362-9.327-6.366T2.928 14.57V5.855zm0 16v13.004q4.017-1.294 6.808-4.868T26.144 16H16zm0 0V3.2L5.856 7.693v8.306H16z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gblog_star" xmlns="http://www.w3.org/2000/svg"><path d="M14 22.052L5.324 27.31l2.3-9.859L0 10.813l10.056-.854L14 .692l3.944 9.267L28 10.813l-7.624 6.638 2.3 9.859z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gblog_tag" xmlns="http://www.w3.org/2000/svg"><path d="M17.52 17.52v-7.041h-7.041v7.041h7.041zM28 10.479h-7.041v7.041H28v3.439h-7.041V28H17.52v-7.041h-7.041V28H7.04v-7.041H-.001V17.52H7.04v-7.041H-.001V7.04H7.04V-.001h3.439V7.04h7.041V-.001h3.439V7.04H28v3.439z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gblog_timer" xmlns="http://www.w3.org/2000/svg"><path d="M16 29q4.428 0 7.536-3.143t3.107-7.571-3.107-7.536T16 7.643 8.464 10.75t-3.107 7.536 3.107 7.571T16 29zM26.714 9.786q1.214 1.571 2.107 4.036t.893 4.464q0 5.643-4 9.678T16 32t-9.714-4.036-4-9.678 4-9.678T16 4.572q1.929 0 4.464.929t4.107 2.143l2.143-2.214q1.143.929 2.143 2.143zM14.5 19.857v-9.143h3v9.143h-3zM20.571.001v3.071h-9.143V.001h9.143z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gblog_tree" xmlns="http://www.w3.org/2000/svg"><path d="M32 14.423H20.808V9.616h-3.23v12.77h3.23v-4.807H32v12.845H20.808v-4.807h-6.385v-16h-3.23v4.807H.001V1.579h11.192v4.807h9.615V1.579H32v12.845z"/></svg></defs></svg>




    <div
      class="wrapper "
    >
      <header class="gblog-header">
  <div class="container flex flex-wrap">
    <div class="gblog-header__col-1 flex justify-start hidden-mobile"></div>
    <div class="gblog-header__col-2 flex align-center justify-center ">
      <a class="gblog-header__link" rel="me" href="https://re-dojo.github.io/">
        <span class="gblog-brand flex align-center justify-center">
          <img
            class="gblog-brand__img"
            src="/images/brand/logo.svg"
            alt=""
          />
          <span class="gblog-brand__title">RE-Dojo</span>
        </span>
        
          <span class="gblog-brand__subtitle flex align-center justify-center">Blog about reverse engineering and program analysis</span>
        
      </a>
    </div>
    <div class="gblog-header__col-3 flex justify-end">
      <span id="gblog-dark-mode">
        <svg class="icon gblog_brightness_dark">
          <title></title>
          <use xlink:href="#gblog_brightness_dark"></use>
        </svg>
        <svg class="icon gblog_brightness_light">
          <title></title>
          <use xlink:href="#gblog_brightness_light"></use>
        </svg>
        <svg class="icon gblog_brightness_auto">
          <title></title>
          <use xlink:href="#gblog_brightness_auto"></use>
        </svg>
      </span>
    </div>
  </div>
</header>
<nav class="gblog-nav">
  <input type="checkbox" id="menu-control" class="hidden" />
  <div class="gblog-nav__control">
    <label for="menu-control" class="flex align-center justify-center">
      <svg class="icon gblog_menu"><use xlink:href="#gblog_menu"></use></svg>
      <svg class="icon gblog_clear"><use xlink:href="#gblog_clear"></use></svg>
      <span>Navigation</span>
    </label>
  </div>
  <ul class="gblog-nav__list container flex flex-wrap justify-center menu-content">
    
    
      
        
          <li>
            <a
              class="gblog-nav__entry"
              href="/tags/Challenge/"
            >
              Challenge
            </a>
          </li>
        
      
        
          <li>
            <a
              class="gblog-nav__entry"
              href="/tags/Reverse/"
            >
              Reverse
            </a>
          </li>
        
      
    
    
  </ul>
</nav>



      <main class="gblog-page container">
        
  <article class="gblog-post">
    <header class="gblog-post__header">
      
      


      <h1 class="gblog-post__title">Flare-On 9 solutions (part 3)</h1>

      
        <div class="flex flex-wrap align-center gblog-post__meta gblog-post__meta--head">
          <span class="flex align-center no-wrap">
  <svg class="icon gblog_date"><use xlink:href="#gblog_date"></use></svg>
  <span class="gblog-post__tag">
    <time datetime="2022-11-13T00:00:00Z">
      
      Nov 13, 2022
    </time>
  </span>
</span>

<span class="flex align-center no-wrap">
  <svg class="icon gblog_timer"><use xlink:href="#gblog_timer"></use></svg>
  <span class="gblog-post__tag">8 min read</span>
</span>





  
    
    
      
        <span class="flex align-center no-wrap">
          <svg class="icon gblog_person"><use xlink:href="#gblog_person"></use></svg>
          
  <span class="gblog-post__tag gblog-button gblog-button--regular">
    <a class="gblog-button__link" href="/authors/icecr4ck/" title="All posts of this author">
      icecr4ck
    </a>
  </span>

        </span>
      
    
    
  




  
    
    
      
        <span class="flex align-center no-wrap">
          <svg class="icon gblog_bookmark"><use xlink:href="#gblog_bookmark"></use></svg>
          
  <span class="gblog-post__tag gblog-button gblog-button--regular">
    <a
      class="gblog-button__link"
      href="/tags/Challenge/"
      title="All posts tagged with 'Challenge'"
    >
      Challenge
    </a>
  </span>

        </span>
      
    
    
  
    
    
      
        <span class="flex align-center">
          
  <span class="gblog-post__tag gblog-button gblog-button--regular">
    <a
      class="gblog-button__link"
      href="/tags/Reverse/"
      title="All posts tagged with 'Reverse'"
    >
      Reverse
    </a>
  </span>

        </span>
      
    
    
  






        </div>
      
    </header>
    <section class="gblog-markdown">
      <p>This blog post details the solution of the challenge 8 of the Flare-On 9.</p>



  <div class="gblog-toc gblog-toc__level--6">
    <nav id="TableOfContents"><ul>
        <li><a href="#challenge-8---backdoor">Challenge 8 - backdoor</a>
          <ul>
            <li><a href="#description">Description</a></li>
            <li><a href="#first-look">First look</a></li>
            <li><a href="#understanding-the-first-layer-of-obfuscation">Understanding the first layer of obfuscation</a></li>
            <li><a href="#recovering-the-first-layer-methods">Recovering the first layer methods</a></li>
            <li><a href="#understanding-the-second-layer-of-obfuscation">Understanding the second layer of obfuscation</a></li>
            <li><a href="#recovering-the-second-layer-methods">Recovering the second layer methods</a></li>
            <li><a href="#analyzing-the-backdoor">Analyzing the backdoor</a>
              <ul>
                <li><a href="#initialization">Initialization</a></li>
                <li><a href="#communication-protocol">Communication protocol</a></li>
                <li><a href="#command-execution">Command execution</a></li>
              </ul>
            </li>
            <li><a href="#decrypting-the-final-stage">Decrypting the final stage</a></li>
          </ul>
        </li>
      </ul></nav>
    <hr />
  </div>


<p>Here are the links to the other solutions:</p>
<ul>
<li><a
  class="gblog-markdown__link"
  href="https://re-dojo.github.io/post/2022-11-13-FlareOn-9-part-1/"
  
>part 1</a> for challenges 1 to 4;</li>
<li><a
  class="gblog-markdown__link"
  href="https://re-dojo.github.io/post/2022-11-13-FlareOn-9-part-2/"
  
>part 2</a> for challenges 5 to 7;</li>
<li><a
  class="gblog-markdown__link"
  href="https://re-dojo.github.io/post/2022-11-13-FlareOn-9-part-4/"
  
>part 4</a> for challenges 9 to 11.</li>
</ul>
<div class="gblog-post__anchorwrap">
    <h2 id="challenge-8---backdoor">
        Challenge 8 - backdoor
        <a data-clipboard-text="https://re-dojo.github.io/post/2022-11-13-FlareOn-9-part-3/#challenge-8---backdoor" class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor Challenge 8 - backdoor" href="#challenge-8---backdoor">
            <svg class="icon gblog_link"><use xlink:href="#gblog_link"></use></svg>
        </a>
    </h2>
</div>
<div class="gblog-post__anchorwrap">
    <h3 id="description">
        Description
        <a data-clipboard-text="https://re-dojo.github.io/post/2022-11-13-FlareOn-9-part-3/#description" class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor Description" href="#description">
            <svg class="icon gblog_link"><use xlink:href="#gblog_link"></use></svg>
        </a>
    </h3>
</div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-md" data-lang="md"><span class="line"><span class="cl">I&#39;m such a backdoor, decompile me why don&#39;t you...
</span></span></code></pre></div><p>The eight challenge is a PE executable written in .NET.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ file FlareOn.Backdoor.exe
</span></span><span class="line"><span class="cl">FlareOn.Backdoor.exe: PE32 executable <span class="o">(</span>console<span class="o">)</span> Intel <span class="m">80386</span> Mono/.Net assembly, <span class="k">for</span> MS Windows
</span></span></code></pre></div><div class="gblog-post__anchorwrap">
    <h3 id="first-look">
        First look
        <a data-clipboard-text="https://re-dojo.github.io/post/2022-11-13-FlareOn-9-part-3/#first-look" class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor First look" href="#first-look">
            <svg class="icon gblog_link"><use xlink:href="#gblog_link"></use></svg>
        </a>
    </h3>
</div>
<p>When the executable is opened in dnSpy, we quickly understand that something is wrong.</p>
<figure><img src="/images/flareon9/Challenge_8_main_function.png"/>
</figure>

<p>Looking more closely at the other functions of the executable, we can divide them into two categories.</p>
<ul>
<li><code>flare_XX()</code>: classic C# bytecode, can be decompiled using dnSpy.</li>
<li><code>flared_XX()</code>: obfuscated/encrypted functions.</li>
</ul>
<figure><img src="/images/flareon9/Challenge_8_function_list.png"/>
</figure>

<div class="gblog-post__anchorwrap">
    <h3 id="understanding-the-first-layer-of-obfuscation">
        Understanding the first layer of obfuscation
        <a data-clipboard-text="https://re-dojo.github.io/post/2022-11-13-FlareOn-9-part-3/#understanding-the-first-layer-of-obfuscation" class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor Understanding the first layer of obfuscation" href="#understanding-the-first-layer-of-obfuscation">
            <svg class="icon gblog_link"><use xlink:href="#gblog_link"></use></svg>
        </a>
    </h3>
</div>
<p>If we follow the execution flow from the <code>Main()</code> function, the function <code>FLARE15.flare_74()</code> is called to initialize several global arrays and returns normally. Then, the call <code>Program.flared_38()</code> raises an exception (<code>InvalidProgramException</code>) as the latter is obfuscated/encrypted. The exception is catched and leads to the execution of <code>FLARE15.flare_70()</code>.</p>
<figure><img src="/images/flareon9/Challenge_8_flare_70.png"/>
</figure>

<p>Again, an exception is raised when <code>FLARE15.flared_70()</code> is executed and this time it is handled by <code>FLARE15.flare_71()</code>. Interestingly, the latter also takes two extra parameters: <code>FLARE15.wl_m</code> and <code>FLARE15.wl_b</code> (defined in <code>FLARE15.flare_74()</code>).</p>
<p>This method is not obfuscated and can be easily analyzed once decompiled. Here is what it does.</p>
<ol>
<li>Retrieve the metadata token (pointer in metadata table, see <a
  class="gblog-markdown__link"
  href="https://learn.microsoft.com/en-us/dotnet/standard/metadata-and-self-describing-components#metadata-tokens"
  
>here</a> for more details) of the function that caused the exception from the stack trace.</li>
<li>Get the prototype of the function from the metadata token.</li>
<li>Create a new <code>DynamicMethod</code> from the prototype.</li>
<li>Iterate over the <code>Dictionary</code> given as third parameter (<code>FLARE15.wl_m</code>)
<ul>
<li>each key is an index in the byte array given as fourth parameter (<code>FLARE15.wl_b</code>), the latter is actually the bytecode of the dynamic method previously created;</li>
<li>each value is a valid metadata token in the program.</li>
</ul>
</li>
<li>Each metadata token is translated into a valid token in the scope of the dynamic method. For example, if the token &ldquo;points&rdquo; to a string of the program, it is first resolved using the <code>Module.ResolveString()</code> function and then a token is created the using <code>DynamicILInfo.GetTokenFor()</code> method.</li>
</ol>
<figure><img src="/images/flareon9/Challenge_8_flare_71_resolve_token.png"/>
</figure>

<ol start="7">
<li>The resulting token is written to the bytecode of the dynamic method at the index specified by the <code>key</code> variable.</li>
</ol>
<figure><img src="/images/flareon9/Challenge_8_flare_71_patch_token.png"/>
</figure>

<ol start="8">
<li>Finally, the patched bytecode is set as the code body of the dynamic method and the latter is executed.</li>
</ol>
<figure><img src="/images/flareon9/Challenge_8_flare_71_exec_bytecode.png"/>
</figure>

<p>In a nutshell, this method patches the bytecode given as parameter using the provided metadata tokens and invokes it as a dynamic method.</p>
<p>Using the &ldquo;Analyzer&rdquo; feature (accessible by right-clicking on method name) of dnSpy, we can identify the locations where <code>FLARE15.flare_71()</code> is called, and thus, the methods obfuscated via this technique.</p>
<figure><img src="/images/flareon9/Challenge_8_flare_71_cross_refs.png"/>
</figure>

<p>For each method, the actual bytecode and the metadata tokens can be retrieved from the parameters given to <code>FLARE15.flare_71()</code>.</p>
<div class="gblog-post__anchorwrap">
    <h3 id="recovering-the-first-layer-methods">
        Recovering the first layer methods
        <a data-clipboard-text="https://re-dojo.github.io/post/2022-11-13-FlareOn-9-part-3/#recovering-the-first-layer-methods" class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor Recovering the first layer methods" href="#recovering-the-first-layer-methods">
            <svg class="icon gblog_link"><use xlink:href="#gblog_link"></use></svg>
        </a>
    </h3>
</div>
<p>From there, I chose to statically fix the obfuscated methods by the actual executed bytecode, in order to get the decompiled code when the patched executable is loaded into dnSpy.</p>
<p>This is actually quite trivial, just follow the steps below for each obfuscated method.</p>
<ol>
<li>Retrieve the real bytecode (i.e <code>cl_b</code>) and the corresponding metadata tokens (i.e <code>cl_m</code>).</li>
<li>Iterate over each <code>key</code>/<code>value</code> of the metadata tokens dictionary, and patch the bytecode at index <code>key</code> with the metadata token <code>value</code>.</li>
<li>Write the resulting bytecode over the obfuscated method in the executable.</li>
</ol>
<p>This can be done in a few lines of Python, my script is available on <a
  class="gblog-markdown__link"
  href="https://github.com/icecr4ck/write-ups/blob/master/FlareOn-9/Challenge_8_backdoor/patch_first_layer.py"
  
>GitHub</a>.</p>
<div class="gblog-post__anchorwrap">
    <h3 id="understanding-the-second-layer-of-obfuscation">
        Understanding the second layer of obfuscation
        <a data-clipboard-text="https://re-dojo.github.io/post/2022-11-13-FlareOn-9-part-3/#understanding-the-second-layer-of-obfuscation" class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor Understanding the second layer of obfuscation" href="#understanding-the-second-layer-of-obfuscation">
            <svg class="icon gblog_link"><use xlink:href="#gblog_link"></use></svg>
        </a>
    </h3>
</div>
<p>Obviously, this was only a first step as lots of methods remain obfuscated/encrypted (including <code>Program.flared_38()</code>), but we can now statically analyze <code>FLARE15.flared_70()</code> (called when <code>Program.flared_38()</code> raises an exception).</p>
<figure><img src="/images/flareon9/Challenge_8_flared_70.png"/>
</figure>

<p>In a nutshell, it decrypts and executes the method that caused the exception. The different steps of this process are detailed below.</p>
<ol>
<li>Get metadata token of the method that raised the exception.</li>
<li><code>FLARE15.flared_66()</code> computes a SHA256 hash of some of the attributes (return type, prototype, etc.) of the method resolved by the token.</li>
<li><code>FLARE15.flared_69()</code> gets the contents of the section whose name starts with the first four bytes (in hexadecimal) of the SHA256 hash previously computed.</li>
<li><code>FLARE15.flared_46()</code> decrypts (RC4) the section contents using the key given as parameter (<code>1278abdf</code> in hexa), the decrypted data corresponds to the actual bytecode of the method.</li>
<li><code>FLARE15.flared_67()</code> decrypts the metadata tokens of the bytecode (XOR with <code>0xa298a6bd</code>) and executes it as a dynamic method (using similar code to <code>flare_71()</code>).</li>
</ol>
<p>This technique is used to protect all the remaining obfuscated methods of the executable.</p>
<div class="gblog-post__anchorwrap">
    <h3 id="recovering-the-second-layer-methods">
        Recovering the second layer methods
        <a data-clipboard-text="https://re-dojo.github.io/post/2022-11-13-FlareOn-9-part-3/#recovering-the-second-layer-methods" class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor Recovering the second layer methods" href="#recovering-the-second-layer-methods">
            <svg class="icon gblog_link"><use xlink:href="#gblog_link"></use></svg>
        </a>
    </h3>
</div>
<p>Again, I chose to decrypt the obfuscated methods statically.</p>
<p>This time, the algorithm is a bit more complex as <code>FLARE15.flared_67()</code> uses a large hardcoded dictionary to identify the offsets of the bytecode to patch. The most painful part of this step was probably to retrieve the relation between a section name (containing the encrypted bytecode) and the offset of the obfuscated method in the executable.</p>
<p>The Python script I used to patch the second layer of obfuscation is available on <a
  class="gblog-markdown__link"
  href="https://github.com/icecr4ck/write-ups/blob/master/FlareOn-9/Challenge_8_backdoor/patch_second_layer.py"
  
>GitHub</a>.</p>
<div class="gblog-post__anchorwrap">
    <h3 id="analyzing-the-backdoor">
        Analyzing the backdoor
        <a data-clipboard-text="https://re-dojo.github.io/post/2022-11-13-FlareOn-9-part-3/#analyzing-the-backdoor" class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor Analyzing the backdoor" href="#analyzing-the-backdoor">
            <svg class="icon gblog_link"><use xlink:href="#gblog_link"></use></svg>
        </a>
    </h3>
</div>
<p>Once the obfuscation is defeated, we can finally analyze the actual code of the backdoor, starting with the <code>Program.flared_38()</code> method.</p>
<div class="gblog-post__anchorwrap">
    <h4 id="initialization">
        Initialization
        <a data-clipboard-text="https://re-dojo.github.io/post/2022-11-13-FlareOn-9-part-3/#initialization" class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor Initialization" href="#initialization">
            <svg class="icon gblog_link"><use xlink:href="#gblog_link"></use></svg>
        </a>
    </h4>
</div>
<p>After creating a <code>Mutex</code> (set to <code>e94901cd-77d9-44ca-9e5a-125190bcf317</code>), the method initializes several variables in the <code>FLARE13</code> module before entering a while loop where the control flow seems to have been flattened.</p>
<figure><img src="/images/flareon9/Challenge_8_flared_38_cff.png"/>
</figure>

<p>The <code>FLARE13.flare_50()</code> is responsible to update the <code>FLARE13.cs</code> variable which indicates the next method to call. The latter depends on the return value of the method given as parameter as well as on a dictionary (<code>FLARE13.t</code>) initialized by <code>FLARE13.flare_48()</code>.</p>
<p>Before entering the while loop, a file named <code>flare.agent.id</code> is created in the same directory as the backdoor. It contains an <code>agent_id</code> (set to <code>-</code> by default) and a <code>counter</code> (set to a random value between 0 and 46656). We will return on these two variables in the next sections.</p>
<p>The first case to be executed is <code>FLARE08.A</code> but it does not call any method, which only sets the next case to <code>FLARE08.C</code> (as shown on the screenshot below). The latter initializes a communication channel with the Command and Control server.</p>
<figure><img src="/images/flareon9/Challenge_8_flared_48.png"/>
</figure>

<div class="gblog-post__anchorwrap">
    <h4 id="communication-protocol">
        Communication protocol
        <a data-clipboard-text="https://re-dojo.github.io/post/2022-11-13-FlareOn-9-part-3/#communication-protocol" class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor Communication protocol" href="#communication-protocol">
            <svg class="icon gblog_link"><use xlink:href="#gblog_link"></use></svg>
        </a>
    </h4>
</div>
<p>The backdoor communicates with its Command &amp; Control (C&amp;C) server via DNS (only A queries are supported).</p>
<p>Obviously, the domain name of the C&amp;C server is <code>flare-on.com</code> and the payload is encoded using a custom algorithm as a sub-domain.</p>
<p>The method responsible for building the payload is <code>FLARE05.flared_29()</code>. It takes two parameters:</p>
<ul>
<li>a payload type (<code>FLARE06.DomT</code>));</li>
<li>a string.</li>
</ul>
<p>Five different payload types are implemented by the backdoor, they are detailed in the following table.</p>
<div class=table-wrap> <table>
<thead>
<tr>
<th>Payload type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>FLARE06.DomT.A</td>
<td>Initialize communication with C&amp;C</td>
</tr>
<tr>
<td>FLARE06.DomT.B</td>
<td>Send result data</td>
</tr>
<tr>
<td>FLARE06.DomT.C</td>
<td>Ask for task data</td>
</tr>
<tr>
<td>FLARE06.DomT.D</td>
<td>Ask for next task</td>
</tr>
<tr>
<td>FLARE06.DomT.E</td>
<td>Ask for task</td>
</tr>
</tbody>
</table> </div>
<p>The following sequence diagram sums up how the different payloads are used by the backdoor.</p>
<figure><img src="/images/flareon9/Challenge_8_seq_diagram.png"/>
</figure>

<p>Payload data is encoded using a substitution alphabet built from the <code>counter</code>. More precisely, the alphabet is randomly generated using a <a
  class="gblog-markdown__link"
  href="https://en.wikipedia.org/wiki/Mersenne_Twister"
  
>Mersenne-Twister</a> seeded with the <code>counter</code>. The latter is incremented by one after each request to the C&amp;C server.</p>
<p>As the value of the <code>counter</code> is also randomly generated, it is encoded using another substitution alphabet (hardcoded this time) and sent to the C&amp;C server.</p>
<div class="gblog-post__anchorwrap">
    <h4 id="command-execution">
        Command execution
        <a data-clipboard-text="https://re-dojo.github.io/post/2022-11-13-FlareOn-9-part-3/#command-execution" class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor Command execution" href="#command-execution">
            <svg class="icon gblog_link"><use xlink:href="#gblog_link"></use></svg>
        </a>
    </h4>
</div>
<p>Once the backdoor has finished to received task data, it calls the method <code>FLARE07.flared_56()</code> to process the task.</p>
<p>The first byte of task data corresponds to the task type (defined in <code>FLARE06.TT</code>). Depending on the latter, the rest of the task data can be decompressed before being interpreted.</p>
<div class=table-wrap> <table>
<thead>
<tr>
<th>Type</th>
<th>Is compressed</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>FLARE06.TT.A</code></td>
<td>N/A</td>
<td>Not implemented</td>
</tr>
<tr>
<td><code>FLARE06.TT.B</code></td>
<td>Yes</td>
<td>Execute a command</td>
</tr>
<tr>
<td><code>FLARE06.TT.C</code></td>
<td>No</td>
<td>Execute a command</td>
</tr>
<tr>
<td><code>FLARE06.TT.D</code></td>
<td>No</td>
<td>Write <code>:)</code> to the given file path</td>
</tr>
<tr>
<td><code>FLARE06.TT.E</code></td>
<td>Yes</td>
<td>Write <code>:)</code> to the given file path</td>
</tr>
</tbody>
</table> </div>
<p>Various commands are supported by the backdoor, and most of them are base64-encoded.</p>
<figure><img src="/images/flareon9/Challenge_8_command_example.png"/>
</figure>

<p>Once decoded, the command shown on the screenshot above corresponds to:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="p">$(</span><span class="n">ping</span> <span class="n">-n</span> <span class="n">1</span> <span class="n">10</span><span class="p">.</span><span class="n">65</span><span class="p">.</span><span class="n">45</span><span class="p">.</span><span class="n">3</span> <span class="p">|</span> <span class="n">findstr</span> <span class="p">/</span><span class="n">i</span> <span class="n">ttl</span><span class="p">)</span> <span class="o">-eq</span> <span class="nv">$null</span><span class="p">;$(</span><span class="n">ping</span> <span class="n">-n</span> <span class="n">1</span> <span class="n">10</span><span class="p">.</span><span class="n">65</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">52</span> <span class="p">|</span> <span class="n">findstr</span> <span class="p">/</span><span class="n">i</span> <span class="n">ttl</span><span class="p">)</span> <span class="o">-eq</span> <span class="nv">$null</span><span class="p">;$(</span><span class="n">ping</span> <span class="n">-n</span> <span class="n">1</span> <span class="n">10</span><span class="p">.</span><span class="n">65</span><span class="p">.</span><span class="n">31</span><span class="p">.</span><span class="n">155</span> <span class="p">|</span> <span class="n">findstr</span> <span class="p">/</span><span class="n">i</span> <span class="n">ttl</span><span class="p">)</span> <span class="o">-eq</span> <span class="nv">$null</span><span class="p">;$(</span><span class="n">ping</span> <span class="n">-n</span> <span class="n">1</span> <span class="nb">flare-on</span><span class="p">.</span><span class="n">com</span> <span class="p">|</span> <span class="n">findstr</span> <span class="p">/</span><span class="n">i</span> <span class="n">ttl</span><span class="p">)</span> <span class="o">-eq</span> <span class="nv">$null</span>
</span></span></code></pre></div><p>Interestingly, most of the commands append a short string to a global variable (<code>FLARE14.h</code>) when they are executed. Two other methods also use this global variable.</p>
<ul>
<li><code>FLARE11.flared_42()</code> initializes the Mersenne-Twister algorithm but also the variable <code>FLARE14.h</code> as an <code>IncrementalHash</code> object (only once). <code>IncrementalHash</code> provides support for computing hashes incrementally across several segments. In our case segments are the short strings appended by the commands of the backdoor.</li>
</ul>
<figure><img src="/images/flareon9/Challenge_8_flared_42.png"/>
</figure>

<ul>
<li><code>FLARE14.flared_54()</code> reverses <code>FLARE14.sh</code> to obtain a section name, computes the hash to get a RC4 key and uses it to decrypt the section data. Then it decrypts the hash with a hardcoded RC4 key to get a filename, and writes the decrypted section data to this file. Finally, the latter is executed/started as a new process.</li>
</ul>
<figure><img src="/images/flareon9/Challenge_8_flared_54.png"/>
</figure>

<div class="gblog-post__anchorwrap">
    <h3 id="decrypting-the-final-stage">
        Decrypting the final stage
        <a data-clipboard-text="https://re-dojo.github.io/post/2022-11-13-FlareOn-9-part-3/#decrypting-the-final-stage" class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor Decrypting the final stage" href="#decrypting-the-final-stage">
            <svg class="icon gblog_link"><use xlink:href="#gblog_link"></use></svg>
        </a>
    </h3>
</div>
<p>At this point, we understand that we have to execute commands in a particular order by the backdoor to decrypt and execute the next (and maybe final) stage.</p>
<p>To determine the order in which the commands have to be executed, we need to understand how <code>FLARE14.sh</code> is built. The method responsible for updating this variable is <code>flared_55()</code>.</p>
<figure><img src="/images/flareon9/Challenge_8_flared_55.png"/>
</figure>

<p>This method takes the command identifier and the short string corresponding to the command as parameters. It checks if the first item of <code>FLARE15.c</code> corresponds to the command identifier XORed with 248. If it is the case, the short string is appended to <code>FLARE14.sh</code> and the item that matched in <code>FLARE15.c</code> is removed. Thus this array gives us the order in which the commands have to be executed.</p>
<figure><img src="/images/flareon9/Challenge_8_observable_collection.png"/>
</figure>

<p>I chose to implement my own C&amp;C server to execute the different commands. The code is available on <a
  class="gblog-markdown__link"
  href="https://github.com/icecr4ck/write-ups/blob/master/FlareOn-9/Challenge_8_backdoor/c2_server.py"
  
>GitHub</a>.</p>
<p>After executing all the commands, a GIF file is finally decrypted by the backdoor.</p>
<figure><img src="/images/flareon9/Challenge_8_flag.gif"/>
</figure>


    </section>
  </article>

      </main>

      <footer class="gblog-footer">
  <nav class="container flex">
    <div>
      <section class="flex flex-wrap align-center">
        
        
        
        
      </section>
      <section class="flex flex-wrap align-center">
        <span class="gblog-footer__item">
          Built with <a href="https://gohugo.io/" class="gblog-footer__link">Hugo</a> and
          <svg class="icon gblog_heart"><use xlink:href="#gblog_heart"></use></svg>
        </span>
      </section>
      
      
        <section class="flex flex-wrap align-center">
          <span class="gblog-footer__item">
            Content licensed under
            <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="gblog-footer__link no-wrap">CC BY-SA 4.0</a>
          </span>
        </section>
      
    </div>
    
      <div class="flex flex-25 justify-end">
        <span class="gblog-footer__item text-right">
          <a class="gblog-footer__link fake-link" href="#" aria-label="Back to top">
            <svg class="icon gblog_keyboard_arrow_up">
              <use xlink:href="#gblog_keyboard_arrow_up"></use>
            </svg>
            <span class="hidden-mobile">Back to top</span>
          </a>
        </span>
      </div>
    
  </nav>
</footer>

    </div>
  </body>
</html>
