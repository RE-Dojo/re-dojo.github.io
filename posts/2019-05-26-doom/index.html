<!DOCTYPE html>
<html lang="en">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.55.6" />

    
    
    

<title>[NSEC 2019] DOOM (7) â€¢ </title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="[NSEC 2019] DOOM (7)"/>
<meta name="twitter:description" content="We, once again, participated in the NorthSec competition. This article is about the DOOM challenge which was pretty interesting as you had to validate it at the VR station. actgardner already made a write-up that you can find here. I wanted to complete it and show another solution that icecr4ck and I came up with.
Tearing the game apart In order to navigate through the map I used GZDoom builder and loaded the zoombies."/>

<meta property="og:title" content="[NSEC 2019] DOOM (7)" />
<meta property="og:description" content="We, once again, participated in the NorthSec competition. This article is about the DOOM challenge which was pretty interesting as you had to validate it at the VR station. actgardner already made a write-up that you can find here. I wanted to complete it and show another solution that icecr4ck and I came up with.
Tearing the game apart In order to navigate through the map I used GZDoom builder and loaded the zoombies." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://re-dojo.github.io/posts/2019-05-26-doom/" />
<meta property="article:published_time" content="2019-05-22T13:37:00-04:00"/>
<meta property="article:modified_time" content="2019-05-22T13:37:00-04:00"/><meta property="og:site_name" content="RE-Dojo" />


    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.6a83d62c39a364f036df4db1ecd564645635d6c7fc182425cb501218fec485f5.css" integrity="sha256-aoPWLDmjZPA2302x7NVkZFY11sf8GCQly1ASGP7EhfU=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://re-dojo.github.io/"></a>
      </span>
      
        
        
        
        <div class="author-image">
          <img src="https://re-dojo.github.io/img/re-dojo.png" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
      
      
      <p class="site__description">
        
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle"></label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>Posts</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>About</span>
					</a>
				</li>
			 
		
		</li>
	</ul>
</div>

        <section class="social">
	
	
	
	<a href="https://github.com/RE-Dojo" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
</section>

      </div>
    </div>
    


  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>[NSEC 2019] DOOM (7)</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> May 22, 2019
    
    
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/ctf">ctf</a>
           
      
          <a class="badge badge-tag" href="/tags/reverse">reverse</a>
           
      
          <a class="badge badge-tag" href="/tags/nsec-2019">nsec 2019</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 4 min read
</div>


  </header>
  
  
  <div class="post">
    

<p>We, once again, participated in the NorthSec competition.
This article is about the DOOM challenge which was pretty interesting as you had to validate it at the VR station.
actgardner already made a write-up that you can find <a href="http://www.agardner.me/securit/ctf/northsec/2019/2019/05/19/northsec-ctf-part-1-doom.html">here</a>.
I wanted to complete it and show another solution that icecr4ck and I came up with.</p>

<h2 id="tearing-the-game-apart">Tearing the game apart</h2>

<p>In order to navigate through the map I used <strong>GZDoom builder</strong> and loaded the <strong>zoombies.wad</strong> file. You can use the &lsquo;add resource&rsquo; menu and select the folder containing all the other files from the game. This will show you the textures also.</p>

<p><img src="/images/doom/GZbuilder_first_room.png" alt="Image" title="GZBuilder" /></p>

<p>Just by browsing the map, you can find a flag in a closed room.</p>

<p><img src="/images/doom/qr_code_flag.png" alt="Image" title="Hidden QR code" /></p>

<p>Looking at the attributes of this door, you can see an action &ldquo;When player presses use&rdquo; and this action is linked to a script numbered 42.
After wandering the map, one can see that there are more scripted locked doors and also hidden rooms.
<strong>SLADE</strong> is a tool which lets you browse the different files and more importantly it can export the &ldquo;BEHAVIOR.LMP&rdquo; contained in the .wad file.
This file is a compiled script for doom. Then with <strong>listacs</strong> script you can disassemble or decompile the script (but be careful I had some wrong output with the decompilation the first time. I didn&rsquo;t use the latest version).</p>

<p>Remember the locked door with the QR code behind it? The script number 42 is the following code:</p>

<p><img src="/images/doom/storage_room.png" alt="Image" title="Storage room script" /></p>

<p>This door was never meant to be opened.</p>

<h2 id="collecting-the-different-flags">Collecting the different flags</h2>

<h3 id="elevator-1-point">Elevator (1 point)</h3>

<p>The first flag you can obtain is by unlocking the elevator.
The elevator&rsquo;s script just checks if you press &ldquo;4&rdquo; and &ldquo;2&rdquo; on the the switches.</p>

<p><img src="/images/doom/Elevator.png" alt="Image" title="Elevator script" /></p>

<p>This first step would give you 1 point.</p>

<h3 id="blue-card">Blue card</h3>

<p>If you noticed the hidden toxic room, that&rsquo;s where the blue card awaits you.
But there&rsquo;s a trick&hellip;
As you can see on the picture, the highlighted edge is linked to a script but also as soon as you enter the room another script is activated.</p>

<p><img src="/images/doom/Toxic_room.png" alt="Image" title="Toxic room script" /></p>

<p>Once you pass the &ldquo;hidden door&rdquo; the script numbered 31 is executed and that&rsquo;s where a logic bug resides.</p>

<p><img src="/images/doom/logic_bug.png" alt="Image" title="Logic bug" /></p>

<p>The script does a modulo 256 on the player&rsquo;s health and then decreases this value randomly until it is below 20.
The script by the blue card (numbered 32) decreases the player&rsquo;s health by 200.</p>

<p><img src="/images/doom/bluecard_script.png" alt="Image" title="Blue card script" /></p>

<p>The trick here is to go to the other hidden room.</p>

<p><img src="/images/doom/hidden_room.png" alt="Image" title="Hidden room" /></p>

<p>This room contains a potion of 300 health points. The trick here is to have the health between 256 and 266 so that you don&rsquo;t lose health when you enter the room and then when getting the blue card you can lose 200 health points and still survive.</p>

<h3 id="red-card">Red card</h3>

<p>The red card can be obtained after unlocking a specific door. The scripts responsible for its opening are number 21 and 22. They both call the function func4.
This function calls func6 which is collecting the different number or letters from the 6 switches and convert it to a base-10 number.
All the different digits composing that number are put in an array.
The verification code at the end of func4 can be converted to the following python code:</p>

<p><img src="/images/doom/pseudocode.png" alt="Image" title="Python code" /></p>

<p>The code is pretty straightforward and actually pretty simple to translate it to an equation to give it to z3 (SMT solver).
The following script will output the expected combination.</p>

<pre><code class="language-python">from z3 import *
from numpy import base_repr

cmb = [2, 3, 5, 7, 13, 17, 19, 23, 31, 27]

solver = Solver()
digits = [Int(&quot;c_%d&quot; % i) for i in range(10)]
 
for i in range(10):
    solver.add(digits[i] &gt;= 0, digits[i] &lt; 10)
    solver.add(((digits[i] * 100) + (digits[(i+1)%10] * 10) + digits[(i+2)%10]) % cmb[i] == 0)
    solver.add(((digits[i] * 100) + (digits[(i+1)%10] * 10) + digits[(i+2)%10]) != 0)

solution = ''
if solver.check() == z3.sat:
    model = solver.model()
    for i in range(10):
        solution += model[digits[i]].as_string()
print base_repr(int(solution),36)
</code></pre>

<p>Note that z3 takes a little less than 1 minute (at least on this old arse laptop).</p>

<h2 id="conclusion">Conclusion</h2>

<p>The challenge was very funny. I would not recommend doing VR if you only slept 8 hours during the whole weekend drinking Sabotage though&hellip;</p>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/posts/2018-10-28-mars-analytica/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">[NSEC 2018] Mars Analytica (20)</span>
    </a>
    
    
</div>


  

  
    


</article>


        </div>
        
    

<script defer src="https://use.fontawesome.com/releases/v5.5.0/js/all.js" integrity="sha384-GqVMZRt5Gn7tB9D9q7ONtcp4gtHIUEW/yG7h98J7IpE3kpi+srfFyyB/04OV6pG0" crossorigin="anonymous"></script>


    
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
        
    
    <script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    




    



    </body>
</html>
